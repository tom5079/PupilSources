package xyz.quaver.pupil.sources.manatoki

import io.ktor.client.engine.mock.*
import io.ktor.client.engine.okhttp.*
import kotlinx.coroutines.ExperimentalCoroutinesApi
import kotlinx.coroutines.test.runTest
import kotlinx.serialization.decodeFromString
import kotlinx.serialization.json.Json
import org.junit.Assert.assertArrayEquals
import org.junit.Assert.assertEquals
import org.junit.Test

@OptIn(ExperimentalCoroutinesApi::class)
class ManatokiHttpClientTest {

    @Test
    fun main() = runTest {
        val expectedRecentUpload: List<Thumbnail> = Json.decodeFromString("""[{"itemID":"12156666","title":"이세계 귀환 대현자님은 그래도 몰래 살 생각입니다 9-2화","thumbnail":"https://manatoki130.net/data/file/comic/9391578/12156666/thumb-thumbnail_240x280.jpg"},{"itemID":"12156639","title":"열등인의 마검사용자 스킬보드를 구사해서 최강에 이르다 60화","thumbnail":"https://manatoki130.net/data/file/comic/5484545/12156639/thumb-62SJr4IwUWzK_240x280.jpg"},{"itemID":"12156633","title":"보여주고 싶어하는 츠유노짱 27화","thumbnail":"https://manatoki130.net/data/file/comic/531884/12156633/thumb-anrEimNQVKYz_240x280.jpg"},{"itemID":"12156588","title":"공주님 '고문'시간입니다 127.5화","thumbnail":"https://manatoki130.net/data/file/comic/247243/12156588/thumb-gerFN0Vv2nKm_240x280.jpg"},{"itemID":"12156567","title":"이세계 귀환 대현자님은 그래도 몰래 살 생각입니다 9-1화","thumbnail":"https://manatoki130.net/data/file/comic/9391578/12156567/thumb-TgyOEBLzqbVY_240x280.jpg"},{"itemID":"12156534","title":"전부 쳐부순다 21화","thumbnail":"https://manatoki130.net/data/file/comic/11197938/12156534/thumb-thumbnail_240x280.jpg"},{"itemID":"12156507","title":"오오카미 군은 하야카와 양한테 못 이겨 20화","thumbnail":"https://manatoki130.net/data/file/comic/5495103/12156507/thumb-s18VqKHUApLm_240x280.jpg"},{"itemID":"12156456","title":"TSUYOSHI 누구도 이기지 못해, 녀석한테는 38화","thumbnail":"https://manatoki130.net/data/file/comic/198037/12156456/thumb-thumbnail_240x280.jpg"},{"itemID":"12156408","title":"사이코의 세계 29화","thumbnail":"https://manatoki130.net/data/file/comic/9786576/12156408/thumb-rHBA4JT3jl9Z_240x280.jpg"},{"itemID":"12155772","title":"전생귀족 감정 스킬로 성공한다~약소영지를 이어받아서, 우수한 인재를 늘리다보니, 최강영지가 되었다~ 67화","thumbnail":"https://manatoki130.net/data/file/comic/6785308/12155772/thumb-skx1tL0pgTc__240x280.jpg"},{"itemID":"12155637","title":"가브릴 드롭아웃 91화","thumbnail":"https://manatoki130.net/data/file/comic/90410/12155637/thumb-mIQ6olNR1Vz0_240x280.jpg"},{"itemID":"12155448","title":"치트스킬 <사자소생>이 각성해서, 고대 마왕군을 부활시켜버렸습니다 ~아무도 죽게 두지 않는 최강 힐러~ 23-2화","thumbnail":"https://manatoki130.net/data/file/comic/5305231/12155448/thumb-thumbnail_240x280.jpg"}]""")
        val expectedMangaList: List<Thumbnail> = Json.decodeFromString("""[{"itemID":"12157548","title":"네가 여신이면 좋을텐데","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626fee5fcb550_OfFAV2q7_b1075319acbdd02a72dc036381d04522cf0fbb57_240x310.jpg"},{"itemID":"12152820","title":"스파이스와 카스타드","thumbnail":"https://newtoki13.org/data/file/comic/626f8b086df15_flUs2IcW_24bd8f3a4cdb0f4a34786fbe81c508e939b30675.jpg"},{"itemID":"12152796","title":"모노노베 고서점 괴기담","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626f8ad1448e6_GYBTIPm3_37cae7a326bc0d34df9215dcd5f4d07d2673123c_240x310.jpg"},{"itemID":"12145665","title":"전직 수의사 영애는 약혼 파기 당했지만 푹신푹신들에게 대인기입니다!","thumbnail":"https://manatoki130.net/data/file/comic/626ea0c338f2d_qB45kZ2T_b2c0483fb0f4d29927f454bb86cb37a5a75762e9.jpg"},{"itemID":"12134109","title":"패배 히로인이 너무 많아!","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626d61a52f1eb_MPQdGIRC_924474716e8765e49641a0fd65b6f35c8e59e74e_240x310.jpg"},{"itemID":"12130251","title":"흑연의 성자~추방된 회복 술사는, 남아도는 마력으로 어둠 마법을 극한까지 연마한다~","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626d32141e8d0_sfgoVMEd_f623e3d717aa903aadb260e6a6e3a34b5417578b_240x310.jpg"},{"itemID":"12127452","title":"파워 앙투아네트","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626d04c5c154b_DokeuTGb_d88141c577f4f305b4455bdc700a85d092f474c4_240x310.jpg"},{"itemID":"12127413","title":"대장간에서 시작하는 이세계 슬로우 라이프","thumbnail":"https://newtoki13.org/data/file/comic/626d0414c6015_Sd8B3FCl_07d16e968e79e1c23b01601839489deb45c77d9e.jpg"},{"itemID":"12127392","title":"북두의 권 외전 천재 아미바의 이세계 패왕 전설","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626d0365b98a0_dqEf6tOY_d55be6c564ee6f6f64896cab4b72b6e4189095f6_240x310.jpg"},{"itemID":"12121416","title":"클로버","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626c5b3293527_uWKvQNgJ_fad6526e7d7afb5b669903407b1e1864c218990d_240x310.jpg"},{"itemID":"12121413","title":"잠겨진 양호실에서 선생님과","thumbnail":"https://newtoki13.org/data/file/comic/626c5afc7585d_ZV6bL9tv_f97e70355f6e92bca0d4304a002b32841db31382.jpg"},{"itemID":"12120891","title":"전생했더니 15살의 왕비였습니다","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626c36fd0ac1a_7wLalH4r_808c493797f78e91d77574be9f60de11334ca1cd_240x310.jpg"},{"itemID":"12116979","title":"죽음으로 돌아가는 올라운더","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626bde95e25bd_FzD7VPei_c97d38db897f41036e420218a16d1c60e120130c_240x310.jpg"},{"itemID":"12116220","title":"스쿨 오브 트레이드","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626bd54e0978f_fLzeSlp8_402cecfa66486b572853a697716e6fda423e615a_240x310.jpg"},{"itemID":"12116046","title":"있지, 차라리 사귈까? 소꿉친구 미소녀의 부탁으로 위장 남자친구 시작했습니다","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626bd1d4c16c0_CYPBDyWd_152e493600ba0c9facf6492d3c07412a3e022064_240x310.jpg"},{"itemID":"12115812","title":"teeny tiny identity","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626bccf809441_nLd4NmH7_6c7f03a093e712449c0fa3596a51feda635e05e9_240x310.jpg"},{"itemID":"12115806","title":"바주카를 든 천사","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626bccc3e5a2d_D5lfeK7X_42eedb8eb21eb622407535889561de872a4e83e1_240x310.jpg"},{"itemID":"12115782","title":"비밀(아마자키 스이카)","thumbnail":"https://manatoki130.net/data/file/comic/thumb-626bcc2e02865_LTJ2ujyS_07e76f597e91b81d76ef918be8648c9cc755dcaf_240x310.jpg"}]""")
        val expectedTopWeekly: List<TopWeekly> = Json.decodeFromString("""[{"itemID":"12095955","title":"원펀맨 리메이크 208-2화","count":"+353"},{"itemID":"12095946","title":"원펀맨 리메이크 208-1화","count":"+109"},{"itemID":"12067230","title":"촌구석의 아저씨, 검성이 되다~그냥 시골 검술사범이었는데, 대성한 제자들이 나를 내버려주지 않는 건~ 4화","count":"+177"},{"itemID":"12081696","title":"촌구석의 아저씨, 검성이 되다~그냥 시골 검술사범이었는데, 대성한 제자들이 나를 내버려주지 않는 건~ 6화","count":"+135"},{"itemID":"12077067","title":"촌구석의 아저씨, 검성이 되다~그냥 시골 검술사범이었는데, 대성한 제자들이 나를 내버려주지 않는 건~ 5화","count":"+149"},{"itemID":"12091554","title":"촌구석의 아저씨, 검성이 되다~그냥 시골 검술사범이었는데, 대성한 제자들이 나를 내버려주지 않는 건~ 7화","count":"+148"},{"itemID":"12105960","title":"촌구석의 아저씨, 검성이 되다~그냥 시골 검술사범이었는데, 대성한 제자들이 나를 내버려주지 않는 건~ 9화","count":"+202"},{"itemID":"12105954","title":"촌구석의 아저씨, 검성이 되다~그냥 시골 검술사범이었는데, 대성한 제자들이 나를 내버려주지 않는 건~ 8화","count":"+73"},{"itemID":"12071079","title":"킹덤 718화","count":"+75"},{"itemID":"12093078","title":"여친의 친구 28화","count":"+49"},{"itemID":"12090858","title":"이세계 NTR ~절친의 여자를 최강 스킬로 함락시키는 방법~ 27화","count":"+69"},{"itemID":"12132906","title":"전생했더니 슬라임이었던 건에 대하여 95-2화","count":"+219"},{"itemID":"12131757","title":"전생했더니 슬라임이었던 건에 대하여 95-1화","count":"+112"},{"itemID":"12108087","title":"마제 교사와 종속 소녀의 배덕 계약 1화","count":"+72"},{"itemID":"12069207","title":"회복술사의 재시작 44-2화","count":"+65"},{"itemID":"12119529","title":"이러는 게 좋아 18-2화","count":"+39"},{"itemID":"12120054","title":"전생했는데 제7왕자라서 멋대로 마술을 누립니다 89-1화","count":"+58"},{"itemID":"12120159","title":"전생했는데 제7왕자라서 멋대로 마술을 누립니다 89-2화","count":"+133"},{"itemID":"12130911","title":"이세계 미궁에서 하렘을 20-6화","count":"+131"},{"itemID":"12083445","title":"이 만화의 히로인은 모리사키 아마네입니다 1화","count":"+52"},{"itemID":"12119757","title":"고블린 슬레이어 70화","count":"+87"},{"itemID":"12106317","title":"이세계 NTR ~절친의 여자를 최강 스킬로 함락시키는 방법~ 28화","count":"+84"},{"itemID":"12069321","title":"카구야 님은 고백받고 싶어 ~천재들의 연애 두뇌전~ 251화","count":"+161"},{"itemID":"12082278","title":"섹스&던전!!~우리집 지하에 H횟수=레벨의 던전이 출현했다!?~ 28-1화","count":"+47"},{"itemID":"12146571","title":"마도정병의 슬레이브 81.5화","count":"+93"},{"itemID":"12082944","title":"섹스&던전!!~우리집 지하에 H횟수=레벨의 던전이 출현했다!?~ 28-2화","count":"+42"},{"itemID":"12093732","title":"악마에 입문했습니다! 이루마 군 249화","count":"+97"},{"itemID":"12134235","title":"패배 히로인이 너무 많아! 1화","count":"+113"},{"itemID":"12116445","title":"울보 이혼녀 옆집 아줌마 카이 1화","count":"+92"},{"itemID":"12107679","title":"육성 스킬은 이제 필요 없다고 용사 파티에서 해고당했기 때문에, 퇴직금 대신 받은 [영지]를 강하게 만들어본다 23-3화","count":"+58"}]""")

        val mockEngine = MockEngine { _ ->
            respond(javaClass.getResource("/index.html")!!.readText())
        }

        val client = ManatokiHttpClient(mockEngine)

        val result = client.main()!!

        assertEquals(expectedRecentUpload, result.recentUpload)
        assertEquals(expectedMangaList, result.mangaList)
        assertEquals(expectedTopWeekly, result.topWeekly)
    }

}